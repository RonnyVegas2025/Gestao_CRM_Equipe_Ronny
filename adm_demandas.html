<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Central de Demandas â€¢ Credenciamento</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
  <style>
    textarea{ min-height: 140px; resize: vertical; }
    .hint{ font-size: 12px; opacity: .75; margin-top: 6px; }
  </style>
</head>
<body>

<header class="top">
  <div>
    <h1>Central de Demandas</h1>
    <div class="muted" id="who">Carregandoâ€¦</div>
  </div>

  <div style="display:flex;gap:10px;align-items:center">
    <a class="btn-ghost" href="dashboard.html">Voltar</a>
    <button id="btnLogout" class="btn-ghost">Sair</button>
  </div>
</header>

<main class="wrap">

  <section class="card">
    <h2>âž• Nova demanda</h2>

    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="label">Vendedor responsÃ¡vel *</div>
        <select id="assignedTo"></select>
        <div class="hint">Se estiver vazio, Ã© RLS do profiles2 (jÃ¡ te passei o SQL). ðŸ˜‰</div>
      </div>

      <div>
        <div class="label">Nome do comÃ©rcio *</div>
        <input id="nome" placeholder="Ex: Padaria do ZÃ©">
      </div>

      <div>
        <div class="label">Segmento</div>
        <input id="segmento" placeholder="Ex: Padaria / Mercado / FarmÃ¡cia">
      </div>

      <div>
        <div class="label">Telefone (celular)</div>
        <input id="telefone" inputmode="tel" placeholder="(00) 00000-0000">
      </div>

      <div>
        <div class="label">Telefone 2 (fixo / alternativo)</div>
        <input id="telefone2" inputmode="tel" placeholder="(00) 0000-0000">
      </div>

      <div>
        <div class="label">Contato (nome)</div>
        <input id="contato_nome" placeholder="Ex: Maria">
      </div>

      <div>
        <div class="label">Contato (e-mail)</div>
        <input id="contato_email" type="email" placeholder="contato@empresa.com">
      </div>

      <div>
        <div class="label">UF</div>
        <select id="uf"></select>
      </div>

      <div>
        <div class="label">Cidade</div>
        <input id="cidade" list="cidadesList" placeholder="Escolha/Digite a cidade">
        <datalist id="cidadesList"></datalist>
        <div class="hint">Ao escolher a UF, eu carrego as cidades automaticamente (IBGE).</div>
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="label">ObservaÃ§Ã£o / argumento / instruÃ§Ãµes</div>
      <textarea id="obs" rows="7" placeholder="Contexto da indicaÃ§Ã£o, argumentos, quem pediu, urgÃªncia, etcâ€¦"></textarea>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px">
      <button class="btn" id="btnCreate">Enviar demanda</button>
    </div>
  </section>

  <section class="card">
    <h2>ðŸ“Œ Acompanhamento</h2>
    <div id="list" class="list">Carregandoâ€¦</div>
  </section>

</main>

<div class="toast" id="toast"></div>

<script type="module">
  import { sb } from "./assets/supabaseClient.js";
  import { getProfile, logout, toast, isAdminRole } from "./assets/app.js";

  const who = document.getElementById("who");
  const listEl = document.getElementById("list");
  const sellerSel = document.getElementById("assignedTo");

  const nome = document.getElementById("nome");
  const segmento = document.getElementById("segmento");
  const telefone = document.getElementById("telefone");
  const telefone2 = document.getElementById("telefone2");
  const contato_nome = document.getElementById("contato_nome");
  const contato_email = document.getElementById("contato_email");
  const uf = document.getElementById("uf");
  const cidade = document.getElementById("cidade");
  const cidadesList = document.getElementById("cidadesList");
  const obs = document.getElementById("obs");
  const btnCreate = document.getElementById("btnCreate");

  function norm(s){ return String(s||"").trim().toLowerCase(); }

  function maskPhone(v){
    v = String(v||"").replace(/\D/g,"").slice(0,11);
    if (v.length <= 10) {
      // (00) 0000-0000
      return v
        .replace(/^(\d{2})(\d)/, "($1) $2")
        .replace(/(\d{4})(\d)/, "$1-$2");
    }
    // (00) 00000-0000
    return v
      .replace(/^(\d{2})(\d)/, "($1) $2")
      .replace(/(\d{5})(\d)/, "$1-$2");
  }

  telefone.addEventListener("input", () => telefone.value = maskPhone(telefone.value));
  telefone2.addEventListener("input", () => telefone2.value = maskPhone(telefone2.value));

  const UFS = [
    ["","Selecioneâ€¦"],
    ["AC","Acre"],["AL","Alagoas"],["AP","AmapÃ¡"],["AM","Amazonas"],["BA","Bahia"],
    ["CE","CearÃ¡"],["DF","Distrito Federal"],["ES","EspÃ­rito Santo"],["GO","GoiÃ¡s"],
    ["MA","MaranhÃ£o"],["MT","Mato Grosso"],["MS","Mato Grosso do Sul"],["MG","Minas Gerais"],
    ["PA","ParÃ¡"],["PB","ParaÃ­ba"],["PR","ParanÃ¡"],["PE","Pernambuco"],["PI","PiauÃ­"],
    ["RJ","Rio de Janeiro"],["RN","Rio Grande do Norte"],["RS","Rio Grande do Sul"],
    ["RO","RondÃ´nia"],["RR","Roraima"],["SC","Santa Catarina"],["SP","SÃ£o Paulo"],
    ["SE","Sergipe"],["TO","Tocantins"]
  ];

  uf.innerHTML = UFS.map(([sigla,nome]) => `<option value="${sigla}">${sigla ? sigla+" - "+nome : nome}</option>`).join("");

  async function loadCitiesByUF(sigla){
    cidadesList.innerHTML = "";
    cidade.value = "";
    if(!sigla) return;

    try{
      // API pÃºblica do IBGE
      const resp = await fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${sigla}/municipios`);
      const arr = await resp.json();
      cidadesList.innerHTML = (arr||[])
        .map(x => `<option value="${x.nome}"></option>`)
        .join("");
    }catch(e){
      console.error("IBGE fetch error:", e);
      // sem drama, deixa o usuÃ¡rio digitar
    }
  }

  uf.addEventListener("change", () => loadCitiesByUF(uf.value));

  function itemHTML(d){
    return `
      <div class="item">
        <div class="row">
          <b>${d.nome_comercio}</b>
          <span class="badge">${d.status}</span>
        </div>
        <div class="muted">
          Vendedor: <b>${d.assigned_nome || "â€”"}</b><br>
          ${(d.segmento || "â€”")} â€¢ ${(d.telefone || "â€”")}${d.telefone2 ? " / "+d.telefone2 : ""} â€¢ ${(d.cidade ? `${d.cidade}/${d.uf||""}` : "â€”")}
        </div>
        ${d.observacao ? `<div class="small" style="margin-top:6px">${d.observacao}</div>` : ""}
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          ${d.negociacao_id ? `<a class="btn" href="negociacao.html?id=${d.negociacao_id}">Abrir negociaÃ§Ã£o</a>` : ""}
        </div>
      </div>
    `;
  }

  async function loadSellers(){
    const { data, error } = await sb
      .from("profiles2")
      .select("id,nome,papel")
      .order("nome", { ascending: true });

    if (error) throw error;

    // aceita vendedor mesmo se vier "Vendedor", "VENDEDOR", etc
    const sellers = (data || []).filter(p => norm(p.papel) === "vendedor");

    if (!sellers.length) {
      sellerSel.innerHTML = `<option value="">(Nenhum vendedor cadastrado no profiles2)</option>`;
      return;
    }

    sellerSel.innerHTML = sellers.map(s => `<option value="${s.id}">${s.nome}</option>`).join("");
  }

  async function loadList(){
    const { data, error } = await sb
      .from("demandas_credenciamento")
      .select("id,nome_comercio,segmento,telefone,telefone2,uf,cidade,observacao,status,assigned_to,negociacao_id,created_at")
      .order("created_at", { ascending: false });

    if (error) throw error;

    const { data: profs, error: pErr } = await sb
      .from("profiles2")
      .select("id,nome");

    if (pErr) throw pErr;

    const map = new Map((profs||[]).map(x => [x.id, x.nome]));

    const enriched = (data || []).map(d => ({
      ...d,
      assigned_nome: map.get(d.assigned_to)
    }));

    listEl.innerHTML = enriched.length ? enriched.map(itemHTML).join("") : `<div class="muted"><i>Nenhuma demanda ainda.</i></div>`;
  }

  async function createDemand(userId){
    const assigned_to = sellerSel.value;

    if (!assigned_to) return toast("Escolhe um vendedor primeiro.");
    if (!nome.value.trim()) return toast("Faltou o nome do comÃ©rcio.");

    const payload = {
      created_by: userId,
      assigned_to,
      status: "pendente",
      nome_comercio: nome.value.trim(),
      segmento: segmento.value.trim() || null,
      telefone: telefone.value.trim() || null,
      telefone2: telefone2.value.trim() || null,
      contato_nome: contato_nome.value.trim() || null,
      contato_email: contato_email.value.trim() || null,
      uf: (uf.value || "").trim().toUpperCase() || null,
      cidade: cidade.value.trim() || null,
      observacao: obs.value.trim() || null,
    };

    const { error } = await sb.from("demandas_credenciamento").insert(payload);
    if (error) throw error;

    // limpa
    nome.value = "";
    segmento.value = "";
    telefone.value = "";
    telefone2.value = "";
    contato_nome.value = "";
    contato_email.value = "";
    uf.value = "";
    cidade.value = "";
    obs.value = "";
    cidadesList.innerHTML = "";
  }

  try{
    const { user, profile } = await getProfile();
    who.textContent = `${profile.nome} â€¢ ${profile.papel}`;

    document.getElementById("btnLogout").onclick = logout;

    if (!isAdminRole(profile.papel)) {
      toast("Seu usuÃ¡rio nÃ£o tem acesso Ã  Central.");
      location.href = "dashboard.html";
    }

    await loadSellers();
    await loadList();

    btnCreate.addEventListener("click", async () => {
      btnCreate.disabled = true;
      btnCreate.textContent = "Enviandoâ€¦";
      try{
        await createDemand(user.id);
        toast("Demanda enviada âœ…");
        await loadList();
      }catch(err){
        console.error(err);
        toast("Erro ao enviar demanda. Veja F12.");
      }finally{
        btnCreate.disabled = false;
        btnCreate.textContent = "Enviar demanda";
      }
    });

  }catch(err){
    console.error(err);
    toast("Erro ao carregar Central. Veja F12.");
    listEl.innerHTML = `<div class="muted">Falha ao carregar.</div>`;
  }
</script>

</body>
</html>
