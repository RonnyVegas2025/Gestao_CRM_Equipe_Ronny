<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>ADM â€¢ Demandas â€¢ Credenciamento</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="assets/app.css" />
</head>
<body>

  <header class="top">
    <div>
      <h1>ADM â€¢ Demandas (Credenciamento)</h1>
      <div class="muted" id="who">Carregandoâ€¦</div>
    </div>

    <div class="row" style="gap:10px">
      <a class="btn-ghost" href="dashboard.html">Voltar</a>
      <button id="btnLogout" class="btn-ghost">Sair</button>
    </div>
  </header>

  <main class="wrap">

    <section class="card">
      <h2>âž• Nova demanda</h2>

      <div class="grid" style="grid-template-columns: 1fr 1fr; gap:12px">
        <div>
          <label class="muted small">Vendedor responsÃ¡vel</label>
          <select id="assignedTo">
            <option value="">Carregando vendedoresâ€¦</option>
          </select>
        </div>

        <div>
          <label class="muted small">Telefone</label>
          <input id="telefone" placeholder="(xx) xxxxx-xxxx" />
        </div>

        <div>
          <label class="muted small">Nome do comÃ©rcio *</label>
          <input id="nomeComercio" placeholder="Ex: Padaria do ZÃ©" />
        </div>

        <div>
          <label class="muted small">Segmento</label>
          <input id="segmento" placeholder="Ex: AlimentaÃ§Ã£o / Mercado / FarmÃ¡cia" />
        </div>

        <div>
          <label class="muted small">UF</label>
          <input id="uf" maxlength="2" placeholder="SP" />
        </div>

        <div>
          <label class="muted small">Cidade</label>
          <input id="cidade" placeholder="Americana" />
        </div>

        <div>
          <label class="muted small">Contato (nome)</label>
          <input id="contatoNome" placeholder="Ex: Marcos" />
        </div>

        <div>
          <label class="muted small">Contato (e-mail)</label>
          <input id="contatoEmail" type="email" placeholder="ex@empresa.com" />
        </div>
      </div>

      <div style="margin-top:12px">
        <label class="muted small">ObservaÃ§Ã£o / Argumentos</label>
        <textarea id="observacao" rows="4" placeholder="Contexto da indicaÃ§Ã£o, argumentos, quem pediu, urgÃªncia etc."></textarea>
      </div>

      <div class="row" style="margin-top:12px; gap:10px; justify-content:flex-end">
        <button class="btn" id="btnCreate">Criar demanda</button>
      </div>

      <div class="muted small" id="createInfo" style="margin-top:10px"></div>
    </section>

    <section class="card">
      <h2>ðŸ“Œ Demandas criadas</h2>

      <div class="row" style="gap:10px; flex-wrap:wrap; align-items:center">
        <select id="filterStatus">
          <option value="todos">Todos</option>
          <option value="pendente">Pendente</option>
          <option value="aceita">Aceita</option>
          <option value="concluida">ConcluÃ­da</option>
          <option value="cancelada">Cancelada</option>
        </select>

        <button class="btn-ghost" id="btnReload">Atualizar</button>
      </div>

      <div id="lista" class="list" style="margin-top:12px">Carregandoâ€¦</div>
    </section>

  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { getProfile, logout, toast, isAdminPapel } from "./assets/app.js";

    const whoEl = document.getElementById("who");
    const btnLogout = document.getElementById("btnLogout");

    const assignedToEl = document.getElementById("assignedTo");
    const nomeComercioEl = document.getElementById("nomeComercio");
    const segmentoEl = document.getElementById("segmento");
    const telefoneEl = document.getElementById("telefone");
    const contatoNomeEl = document.getElementById("contatoNome");
    const contatoEmailEl = document.getElementById("contatoEmail");
    const ufEl = document.getElementById("uf");
    const cidadeEl = document.getElementById("cidade");
    const observacaoEl = document.getElementById("observacao");
    const btnCreate = document.getElementById("btnCreate");
    const createInfo = document.getElementById("createInfo");

    const filterStatusEl = document.getElementById("filterStatus");
    const btnReload = document.getElementById("btnReload");
    const listaEl = document.getElementById("lista");

    let me = null;

    function optUser(p){
      const shortId = String(p.id).slice(0, 8);
      return `<option value="${p.id}">${p.nome || "Sem nome"} â€¢ ${p.papel} â€¢ ${shortId}</option>`;
    }

    function badge(status){
      return `<span class="badge">${status}</span>`;
    }

    function itemHTML(d, vendedoresMap){
      const vend = vendedoresMap.get(d.assigned_to);
      const vendTxt = vend ? `${vend.nome} (${vend.papel})` : String(d.assigned_to).slice(0,8);

      return `
        <div class="item">
          <div class="row">
            <b>${d.nome_comercio}</b>
            ${badge(d.status)}
          </div>

          <div class="muted">
            Resp: <b>${vendTxt}</b><br>
            ${d.segmento || "â€”"} â€¢ ${d.telefone || "â€”"}<br>
            ${d.cidade ? (d.cidade + " / " + (d.uf||"")) : ""}
          </div>

          ${d.observacao ? `<div class="small" style="margin-top:8px">${d.observacao}</div>` : ""}

          <div class="row" style="margin-top:10px; gap:10px; flex-wrap:wrap">
            <button class="btn-ghost" data-act="copy" data-id="${d.id}">Copiar ID</button>

            <select data-act="status" data-id="${d.id}">
              <option value="pendente" ${d.status==="pendente"?"selected":""}>pendente</option>
              <option value="aceita" ${d.status==="aceita"?"selected":""}>aceita</option>
              <option value="concluida" ${d.status==="concluida"?"selected":""}>concluida</option>
              <option value="cancelada" ${d.status==="cancelada"?"selected":""}>cancelada</option>
            </select>
          </div>

          <div class="muted small" style="margin-top:8px">
            Criada em: ${new Date(d.created_at).toLocaleString("pt-BR")}
          </div>
        </div>
      `;
    }

    async function loadVendedores(){
      // vendedores = profiles2.papel == 'vendedor'
      const { data, error } = await sb
        .from("profiles2")
        .select("id,nome,papel")
        .eq("papel", "vendedor")
        .order("nome", { ascending: true });

      if (error) throw error;

      const arr = data || [];
      if(!arr.length){
        assignedToEl.innerHTML = `<option value="">Nenhum vendedor cadastrado em profiles2</option>`;
        return { list: [], map: new Map() };
      }

      assignedToEl.innerHTML = `<option value="">Selecioneâ€¦</option>` + arr.map(optUser).join("");
      return { list: arr, map: new Map(arr.map(x => [x.id, x])) };
    }

    async function createDemanda(){
      createInfo.textContent = "";
      const assigned_to = assignedToEl.value;
      const nome_comercio = nomeComercioEl.value.trim();

      if(!assigned_to){
        toast("Escolhe o vendedor responsÃ¡vel ðŸ™‚");
        return;
      }
      if(!nome_comercio){
        toast("Nome do comÃ©rcio Ã© obrigatÃ³rio ðŸ˜…");
        return;
      }

      btnCreate.disabled = true;

      const payload = {
        created_by: me.user.id,
        assigned_to,
        status: "pendente",
        nome_comercio,
        segmento: segmentoEl.value.trim() || null,
        telefone: telefoneEl.value.trim() || null,
        contato_nome: contatoNomeEl.value.trim() || null,
        contato_email: contatoEmailEl.value.trim() || null,
        uf: (ufEl.value.trim() || "").toUpperCase() || null,
        cidade: cidadeEl.value.trim() || null,
        observacao: observacaoEl.value.trim() || null
      };

      try{
        const { error } = await sb.from("demandas_credenciamento").insert(payload);
        if(error) throw error;

        toast("Demanda criada âœ…");
        createInfo.textContent = "Demanda criada com sucesso. Ela vai aparecer nas pendÃªncias do vendedor.";

        // limpa alguns campos
        nomeComercioEl.value = "";
        telefoneEl.value = "";
        observacaoEl.value = "";

        await loadLista(); // atualiza lista
      } catch(err){
        console.error(err);
        toast("Erro ao criar demanda. Veja console (F12).");
        createInfo.textContent = "Falha ao criar. Confere se seu usuÃ¡rio estÃ¡ como gestor/adm em profiles2.";
      } finally {
        btnCreate.disabled = false;
      }
    }

    async function loadLista(){
      listaEl.textContent = "Carregandoâ€¦";

      const statusFilter = filterStatusEl.value;

      // puxa vendedores pra mapear nomes
      const { list, map } = await loadVendedores();

      let q = sb
        .from("demandas_credenciamento")
        .select("id,created_at,status,nome_comercio,segmento,telefone,observacao,uf,cidade,assigned_to")
        .order("created_at", { ascending: false })
        .limit(200);

      if(statusFilter !== "todos"){
        q = q.eq("status", statusFilter);
      }

      const { data, error } = await q;
      if(error) throw error;

      const arr = data || [];
      if(!arr.length){
        listaEl.innerHTML = `<div class="muted"><i>Nenhuma demanda por aqui.</i></div>`;
        return;
      }

      listaEl.innerHTML = arr.map(d => itemHTML(d, map)).join("");

      // events
      listaEl.querySelectorAll("[data-act='copy']").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-id");
          try{
            await navigator.clipboard.writeText(id);
            toast("ID copiado âœ…");
          } catch {
            toast("NÃ£o consegui copiar. Copia na mÃ£o ðŸ˜…");
          }
        });
      });

      listaEl.querySelectorAll("select[data-act='status']").forEach(sel => {
        sel.addEventListener("change", async () => {
          const id = sel.getAttribute("data-id");
          const status = sel.value;

          try{
            const { error } = await sb
              .from("demandas_credenciamento")
              .update({ status })
              .eq("id", id);

            if(error) throw error;
            toast("Status atualizado âœ…");
          } catch(err){
            console.error(err);
            toast("Falha ao atualizar status (RLS?).");
          }
        });
      });
    }

    try{
      me = await getProfile();

      whoEl.textContent = `${me.profile.nome || "UsuÃ¡rio"} â€¢ ${me.profile.papel || "?"}`;

      if(!isAdminPapel(me.profile.papel)){
        toast("Sem permissÃ£o: apenas gestor/adm.");
        listaEl.innerHTML = `<div class="muted">Acesso negado.</div>`;
        throw new Error("not_admin");
      }

      btnLogout.onclick = logout;

      // carregar vendedores e lista
      await loadVendedores();
      await loadLista();

      btnCreate.addEventListener("click", createDemanda);
      btnReload.addEventListener("click", loadLista);
      filterStatusEl.addEventListener("change", loadLista);

    } catch(err){
      console.error(err);
      if(String(err?.message || "").includes("not_admin")) return;
      toast("Erro ao carregar ADM. Veja o console (F12).");
    }
  </script>
</body>
</html>
