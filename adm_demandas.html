<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Demandas â€¢ ADM</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

  <header class="top">
    <div>
      <h1>Demandas â€¢ AdministraÃ§Ã£o</h1>
      <div class="muted" id="who">Carregandoâ€¦</div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <a class="btn-ghost" href="dashboard.html">Voltar</a>
      <button id="btnLogout" class="btn-ghost">Sair</button>
    </div>
  </header>

  <main class="wrap" style="display:grid;gap:16px;grid-template-columns: 1fr 1fr; align-items:start">

    <section class="card">
      <h2>âž• Criar demanda</h2>

      <div class="grid2">
        <div>
          <label class="lbl">Vendedor</label>
          <select id="assigned_to"></select>
        </div>
        <div>
          <label class="lbl">Nome do comÃ©rcio</label>
          <input id="nome_comercio" placeholder="Ex: Mercado Central">
        </div>

        <div>
          <label class="lbl">Segmento</label>
          <input id="segmento" placeholder="Ex: Mercado / FarmÃ¡cia">
        </div>
        <div>
          <label class="lbl">Telefone</label>
          <input id="telefone" placeholder="(xx) xxxxx-xxxx">
        </div>

        <div>
          <label class="lbl">Contato</label>
          <input id="contato_nome" placeholder="Nome do responsÃ¡vel">
        </div>
        <div>
          <label class="lbl">E-mail do contato</label>
          <input id="contato_email" placeholder="email@comercio.com">
        </div>

        <div>
          <label class="lbl">UF</label>
          <input id="uf" placeholder="SP" maxlength="2">
        </div>
        <div>
          <label class="lbl">Cidade</label>
          <input id="cidade" placeholder="Americana">
        </div>
      </div>

      <div style="margin-top:10px">
        <label class="lbl">ObservaÃ§Ã£o (argumentos/infos pro vendedor)</label>
        <textarea id="observacao" rows="4" placeholder="Ex: IndicaÃ§Ã£o da PÃ³s-venda, cliente quer retorno hojeâ€¦"></textarea>
      </div>

      <div style="margin-top:14px">
        <button id="btnCriar" class="btn">Criar demanda</button>
      </div>
    </section>

    <section class="card">
      <h2>ðŸ“Œ Acompanhamento</h2>
      <div id="lista" class="list">Carregandoâ€¦</div>
    </section>

  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { getProfile, logout, toast, isAdminPapel } from "./assets/app.js";

    const selV = document.getElementById("assigned_to");
    const lista = document.getElementById("lista");

    function itemHTML(d){
      const local = d.cidade ? `${d.cidade}${d.uf ? " / "+d.uf : ""}` : "â€”";
      return `
        <div class="item">
          <div class="row">
            <b>${d.nome_comercio}</b>
            <span class="badge">${d.status}</span>
          </div>
          <div class="muted">
            ${d.vendedor_nome || "â€”"}<br>
            ${d.segmento || "â€”"} â€¢ ${d.telefone || "â€”"} â€¢ ${local}
          </div>
          ${d.observacao ? `<div class="small" style="margin-top:6px">${d.observacao}</div>` : ""}
          ${d.negociacao_id ? `<div class="small muted" style="margin-top:8px">NegociaÃ§Ã£o: ${d.negociacao_id}</div>` : ""}
        </div>
      `;
    }

    async function loadVendedores(){
      const { data, error } = await sb
        .from("profiles2")
        .select("id,nome,papel")
        .order("nome", { ascending: true });

      if (error) throw error;

      const vend = (data || []).filter(p => (p.papel || "").toLowerCase() === "vendedor");

      selV.innerHTML = vend.map(v => `<option value="${v.id}">${v.nome || v.id}</option>`).join("");
      if (!vend.length) {
        selV.innerHTML = `<option value="">Nenhum vendedor cadastrado em profiles2</option>`;
      }
    }

    async function loadDemandas(){
      const { data, error } = await sb
        .from("demandas_credenciamento")
        .select("id,nome_comercio,segmento,telefone,observacao,uf,cidade,status,created_at,assigned_to,negociacao_id")
        .order("created_at", { ascending: false });

      if (error) throw error;

      if (!(data||[]).length){
        lista.innerHTML = `<div class="muted"><i>Nenhuma demanda criada ainda.</i></div>`;
        return;
      }

      // buscar nomes dos vendedores
      const ids = [...new Set(data.map(x => x.assigned_to))].filter(Boolean);
      const { data: ps } = await sb.from("profiles2").select("id,nome").in("id", ids);

      const map = new Map((ps||[]).map(p => [p.id, p.nome]));
      const withNames = data.map(d => ({...d, vendedor_nome: map.get(d.assigned_to) || "â€”"}));

      lista.innerHTML = withNames.map(itemHTML).join("");
    }

    function getForm(){
      const uf = (document.getElementById("uf").value || "").trim().toUpperCase().slice(0,2);
      return {
        assigned_to: selV.value,
        nome_comercio: (document.getElementById("nome_comercio").value||"").trim(),
        segmento: (document.getElementById("segmento").value||"").trim(),
        telefone: (document.getElementById("telefone").value||"").trim(),
        contato_nome: (document.getElementById("contato_nome").value||"").trim(),
        contato_email: (document.getElementById("contato_email").value||"").trim(),
        uf,
        cidade: (document.getElementById("cidade").value||"").trim(),
        observacao: (document.getElementById("observacao").value||"").trim(),
      };
    }

    async function createDemanda(user){
      const f = getForm();
      if(!f.assigned_to){
        toast("Selecione um vendedor.");
        return;
      }
      if(!f.nome_comercio){
        toast("Informe o nome do comÃ©rcio.");
        return;
      }

      const payload = {
        created_by: user.id,
        assigned_to: f.assigned_to,
        status: "pendente",
        ...f
      };

      const { error } = await sb.from("demandas_credenciamento").insert(payload);
      if (error) throw error;

      toast("Demanda criada âœ…");
      // limpa bÃ¡sicos
      ["nome_comercio","segmento","telefone","contato_nome","contato_email","uf","cidade","observacao"]
        .forEach(id => document.getElementById(id).value = "");

      await loadDemandas();
    }

    try {
      const { user, profile } = await getProfile();

      document.getElementById("who").textContent = `${user.email} â€¢ ${profile.papel}`;
      document.getElementById("btnLogout").onclick = logout;

      if(!isAdminRole(profile.papel)){
        toast("Sem acesso. Essa tela Ã© sÃ³ para ADM/Gestor.");
        setTimeout(()=> location.href="dashboard.html", 900);
        throw new Error("no_access");
      }

      await loadVendedores();
      await loadDemandas();

      document.getElementById("btnCriar").onclick = async () => {
        try {
          await createDemanda(user);
        } catch (e) {
          console.error(e);
          toast("Erro ao criar demanda. Veja o console (F12).");
        }
      };

    } catch (err) {
      console.error(err);
    }
  </script>
</body>
</html>
