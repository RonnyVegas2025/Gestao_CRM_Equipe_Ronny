<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>ADM â€¢ Demandas de Credenciamento</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

  <header class="top">
    <div>
      <h1>ADM â€¢ Demandas de Credenciamento</h1>
      <div class="muted" id="who">Carregandoâ€¦</div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <a class="btn-ghost" href="dashboard.html">Voltar</a>
      <button id="btnLogout" class="btn-ghost">Sair</button>
    </div>
  </header>

  <main class="wrap">

    <section class="card">
      <h2>âž• Nova demanda</h2>

      <div class="grid" style="margin-top:10px">
        <div>
          <label class="lbl">Vendedor responsÃ¡vel</label>
          <select id="assignedTo" class="inp"></select>
        </div>

        <div>
          <label class="lbl">Nome do comÃ©rcio *</label>
          <input id="nome_comercio" class="inp" placeholder="Ex: Padaria do ZÃ©">
        </div>

        <div>
          <label class="lbl">Segmento</label>
          <input id="segmento" class="inp" placeholder="Ex: AlimentaÃ§Ã£o / FarmÃ¡cia / Mercado">
        </div>

        <div>
          <label class="lbl">Telefone</label>
          <input id="telefone" class="inp" placeholder="(19) 99999-9999">
        </div>

        <div>
          <label class="lbl">Contato (nome)</label>
          <input id="contato_nome" class="inp" placeholder="Ex: Maria">
        </div>

        <div>
          <label class="lbl">Contato (e-mail)</label>
          <input id="contato_email" class="inp" placeholder="email@comercio.com">
        </div>

        <div>
          <label class="lbl">UF</label>
          <input id="uf" class="inp" maxlength="2" placeholder="SP">
        </div>

        <div>
          <label class="lbl">Cidade</label>
          <input id="cidade" class="inp" placeholder="Americana">
        </div>

        <div style="grid-column: 1 / -1">
          <label class="lbl">ObservaÃ§Ã£o / argumento / instruÃ§Ãµes</label>
          <textarea id="observacao" class="inp" rows="4" placeholder="Ex: Cliente Vegas pediu urgÃªncia. JÃ¡ aceita dÃ©bito. Precisa de taxa X..."></textarea>
        </div>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;align-items:center">
        <button id="btnCreate" class="btn">Enviar demanda</button>
        <span class="muted small" id="createInfo"></span>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <h2>ðŸ“Œ Acompanhar demandas</h2>

        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <select id="fStatus" class="inp" style="width:auto">
            <option value="all">Todos status</option>
            <option value="pendente">pendente</option>
            <option value="aceita">aceita</option>
            <option value="concluida">concluida</option>
            <option value="cancelada">cancelada</option>
          </select>

          <input id="fSearch" class="inp" style="width:280px" placeholder="Buscar (comÃ©rcio / cidade / vendedor / telefone)â€¦">
          <button id="btnReload" class="btn-ghost">Atualizar</button>
        </div>
      </div>

      <div id="list" class="list" style="margin-top:12px">Carregandoâ€¦</div>
    </section>

  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { getProfile, logout, toast, isAdminPapel } from "./assets/app.js";

    const who = document.getElementById("who");
    const btnLogout = document.getElementById("btnLogout");
    const assignedTo = document.getElementById("assignedTo");

    const nome_comercio = document.getElementById("nome_comercio");
    const segmento = document.getElementById("segmento");
    const telefone = document.getElementById("telefone");
    const contato_nome = document.getElementById("contato_nome");
    const contato_email = document.getElementById("contato_email");
    const uf = document.getElementById("uf");
    const cidade = document.getElementById("cidade");
    const observacao = document.getElementById("observacao");

    const btnCreate = document.getElementById("btnCreate");
    const createInfo = document.getElementById("createInfo");

    const fStatus = document.getElementById("fStatus");
    const fSearch = document.getElementById("fSearch");
    const btnReload = document.getElementById("btnReload");
    const list = document.getElementById("list");

    let me = null;
    let profile = null;
    let vendedores = []; // [{id,nome}]

    btnLogout.onclick = logout;

    function cleanText(s){ return String(s||"").toLowerCase().trim(); }
    function fmtDate(iso){
      try{
        const d = new Date(iso);
        return d.toLocaleString("pt-BR");
      }catch(e){ return ""; }
    }

    async function loadVendedores(){
      const { data, error } = await sb
        .from("profiles2")
        .select("id,nome,papel")
        .eq("papel", "vendedor")
        .order("nome", { ascending: true });

      if(error) throw error;

      vendedores = data || [];
      assignedTo.innerHTML = "";

      if(!vendedores.length){
        assignedTo.innerHTML = `<option value="">(Nenhum vendedor cadastrado em profiles2)</option>`;
        return;
      }

      vendedores.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.id;
        opt.textContent = v.nome || v.id;
        assignedTo.appendChild(opt);
      });
    }

    function vendedorNomeById(id){
      const v = vendedores.find(x => x.id === id);
      return v?.nome || id || "â€”";
    }

    function demandItemHTML(d){
      const vend = vendedorNomeById(d.assigned_to);

      return `
        <div class="item">
          <div class="row" style="justify-content:space-between;gap:10px">
            <div>
              <b>${d.nome_comercio}</b>
              <div class="muted small">
                ${d.segmento || "â€”"} â€¢ ${d.telefone || "â€”"} â€¢ ${d.cidade ? (d.cidade + " / " + (d.uf||"")) : "â€”"}
              </div>
            </div>

            <span class="badge">${d.status}</span>
          </div>

          <div class="muted" style="margin-top:8px">
            <b>Vendedor:</b> ${vend}
            <span class="small">â€¢ criada em ${fmtDate(d.created_at)}</span>
          </div>

          ${d.observacao ? `<div class="small" style="margin-top:10px">${d.observacao}</div>` : ""}

          <div style="margin-top:12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <label class="small muted">Status:</label>
            <select class="inp" style="width:auto" data-status="${d.id}">
              <option value="pendente" ${d.status==="pendente"?"selected":""}>pendente</option>
              <option value="aceita" ${d.status==="aceita"?"selected":""}>aceita</option>
              <option value="concluida" ${d.status==="concluida"?"selected":""}>concluida</option>
              <option value="cancelada" ${d.status==="cancelada"?"selected":""}>cancelada</option>
            </select>

            <button class="btn-ghost" data-save="${d.id}">Salvar</button>
          </div>
        </div>
      `;
    }

    async function loadDemandas(){
      list.textContent = "Carregandoâ€¦";

      const { data, error } = await sb
        .from("demandas_credenciamento")
        .select("id,assigned_to,status,nome_comercio,segmento,telefone,contato_nome,contato_email,uf,cidade,observacao,created_at")
        .order("created_at", { ascending: false });

      if(error) throw error;

      let rows = data || [];

      // filtro status
      if(fStatus.value !== "all"){
        rows = rows.filter(r => r.status === fStatus.value);
      }

      // filtro texto
      const q = cleanText(fSearch.value);
      if(q){
        rows = rows.filter(r => {
          const blob = [
            r.nome_comercio, r.segmento, r.telefone, r.cidade, r.uf,
            vendedorNomeById(r.assigned_to)
          ].map(cleanText).join(" ");
          return blob.includes(q);
        });
      }

      if(!rows.length){
        list.innerHTML = `<div class="muted"><i>Nenhuma demanda encontrada.</i></div>`;
        return;
      }

      list.innerHTML = rows.map(demandItemHTML).join("");

      // bind save status
      list.querySelectorAll("[data-save]").forEach(btn => {
        btn.addEventListener("click", async () => {
          const id = btn.getAttribute("data-save");
          const sel = list.querySelector(`[data-status="${id}"]`);
          const newStatus = sel?.value;

          if(!newStatus) return;

          const { error: upErr } = await sb
            .from("demandas_credenciamento")
            .update({ status: newStatus })
            .eq("id", id);

          if(upErr){
            console.error(upErr);
            toast("NÃ£o consegui salvar. Ver console (F12).");
            return;
          }

          toast("Status atualizado âœ…");
          await loadDemandas();
        });
      });
    }

    btnReload.addEventListener("click", loadDemandas);
    fStatus.addEventListener("change", loadDemandas);
    fSearch.addEventListener("input", () => {
      clearTimeout(window.__fs);
      window.__fs = setTimeout(loadDemandas, 250);
    });

    btnCreate.addEventListener("click", async () => {
      createInfo.textContent = "";

      const vendId = assignedTo.value;
      const nome = nome_comercio.value.trim();

      if(!vendId){
        toast("Escolhe um vendedor primeiro ðŸ™‚");
        return;
      }
      if(!nome){
        toast("Preenche o nome do comÃ©rcio ðŸ˜‰");
        return;
      }

      const payload = {
        created_by: me.id,
        assigned_to: vendId,
        nome_comercio: nome,
        segmento: segmento.value.trim() || null,
        telefone: telefone.value.trim() || null,
        contato_nome: contato_nome.value.trim() || null,
        contato_email: contato_email.value.trim() || null,
        uf: (uf.value || "").trim().toUpperCase() || null,
        cidade: cidade.value.trim() || null,
        observacao: observacao.value.trim() || null,
        status: "pendente"
      };

      createInfo.textContent = "Enviandoâ€¦";

      const { error } = await sb
        .from("demandas_credenciamento")
        .insert(payload);

      if(error){
        console.error(error);
        createInfo.textContent = "";
        toast("Erro ao criar demanda. Veja o console (F12).");
        return;
      }

      toast("Demanda criada e enviada âœ…");
      createInfo.textContent = "âœ… Enviada!";

      // limpa campos (mantÃ©m vendedor)
      nome_comercio.value = "";
      segmento.value = "";
      telefone.value = "";
      contato_nome.value = "";
      contato_email.value = "";
      uf.value = "";
      cidade.value = "";
      observacao.value = "";

      await loadDemandas();
    });

    // init
    try{
      const res = await getProfile();
      me = res.user;
      profile = res.profile;

      who.textContent = `${profile.nome} â€¢ ${profile.papel}`;

      if(!isAdminPapel(profile.papel)){
        toast("Acesso negado. Esta tela Ã© sÃ³ para gestor/adm.");
        setTimeout(() => location.href = "dashboard.html", 900);
        throw new Error("not_admin");
      }

      await loadVendedores();
      await loadDemandas();

    }catch(err){
      console.error(err);
      if(String(err?.message||"") !== "not_admin"){
        toast("Falha ao carregar ADM. Veja o console (F12).");
      }
    }
  </script>

</body>
</html>
