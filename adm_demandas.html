<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Central de Demandas â€¢ Credenciamento</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

<header class="top">
  <div>
    <h1>Central de Demandas</h1>
    <div class="muted" id="who">Carregandoâ€¦</div>
  </div>

  <div style="display:flex;gap:10px;align-items:center">
    <a class="btn-ghost" href="dashboard.html">Voltar</a>
    <button id="btnLogout" class="btn-ghost">Sair</button>
  </div>
</header>

<main class="wrap">

  <section class="card">
    <h2>âž• Nova demanda</h2>

    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="label">Vendedor</div>
        <select id="assignedTo"></select>
      </div>

      <div>
        <div class="label">Nome do comÃ©rcio</div>
        <input id="nome" placeholder="Ex: Padaria do ZÃ©">
      </div>

      <div>
        <div class="label">Segmento</div>
        <input id="segmento" placeholder="Ex: AlimentaÃ§Ã£o">
      </div>

      <div>
        <div class="label">Telefone</div>
        <input id="telefone" placeholder="(xx) xxxxx-xxxx">
      </div>

      <div>
        <div class="label">UF</div>
        <input id="uf" maxlength="2" placeholder="SP">
      </div>

      <div>
        <div class="label">Cidade</div>
        <input id="cidade" placeholder="Campinas">
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="label">ObservaÃ§Ã£o / Argumentos</div>
      <textarea id="obs" rows="4" placeholder="Contexto da indicaÃ§Ã£o, argumentos, quem pediu, urgÃªnciaâ€¦"></textarea>
    </div>

    <div style="margin-top:12px;display:flex;gap:10px">
      <button class="btn" id="btnCreate">Criar demanda</button>
    </div>
  </section>

  <section class="card">
    <h2>ðŸ“Œ Acompanhamento</h2>
    <div id="list" class="list">Carregandoâ€¦</div>
  </section>

</main>

<div class="toast" id="toast"></div>

<script type="module">
  import { sb } from "./assets/supabaseClient.js";
  import { getProfile, logout, toast, isAdminRole } from "./assets/app.js";

  const who = document.getElementById("who");
  const listEl = document.getElementById("list");
  const sellerSel = document.getElementById("assignedTo");

  const nome = document.getElementById("nome");
  const segmento = document.getElementById("segmento");
  const telefone = document.getElementById("telefone");
  const uf = document.getElementById("uf");
  const cidade = document.getElementById("cidade");
  const obs = document.getElementById("obs");
  const btnCreate = document.getElementById("btnCreate");

  function itemHTML(d){
    return `
      <div class="item">
        <div class="row">
          <b>${d.nome_comercio}</b>
          <span class="badge">${d.status}</span>
        </div>
        <div class="muted">
          Vendedor: <b>${d.assigned_nome || "â€”"}</b><br>
          ${(d.segmento || "â€”")} â€¢ ${(d.telefone || "â€”")} â€¢ ${(d.cidade ? `${d.cidade}/${d.uf||""}` : "â€”")}
        </div>
        ${d.observacao ? `<div class="small" style="margin-top:6px">${d.observacao}</div>` : ""}

        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          ${d.negociacao_id ? `<a class="btn" href="negociacao.html?id=${d.negociacao_id}">Abrir negociaÃ§Ã£o</a>` : ""}
        </div>
      </div>
    `;
  }

  async function loadSellers(){
    const { data, error } = await sb
      .from("profiles2")
      .select("id,nome,papel")
      .order("nome", { ascending: true });

    if (error) throw error;

    const sellers = (data || []).filter(p => String(p.papel).toLowerCase() === "vendedor");
    sellerSel.innerHTML = sellers.map(s => `<option value="${s.id}">${s.nome}</option>`).join("");

    if (!sellers.length) {
      sellerSel.innerHTML = `<option value="">(Nenhum vendedor cadastrado no profiles2)</option>`;
    }
  }

  async function loadList(){
    // pega demandas
    const { data, error } = await sb
      .from("demandas_credenciamento")
      .select("id,nome_comercio,segmento,telefone,uf,cidade,observacao,status,assigned_to,negociacao_id,created_at")
      .order("created_at", { ascending: false });

    if (error) throw error;

    // pega perfis pra mapear nome
    const { data: profs, error: pErr } = await sb
      .from("profiles2")
      .select("id,nome");

    if (pErr) throw pErr;

    const map = new Map((profs||[]).map(x => [x.id, x.nome]));

    const enriched = (data || []).map(d => ({
      ...d,
      assigned_nome: map.get(d.assigned_to)
    }));

    listEl.innerHTML = enriched.length ? enriched.map(itemHTML).join("") : `<div class="muted"><i>Nenhuma demanda ainda.</i></div>`;
  }

  async function createDemand(userId){
    const assigned_to = sellerSel.value;

    if (!assigned_to) return toast("Escolhe um vendedor primeiro.");
    if (!nome.value.trim()) return toast("Faltou o nome do comÃ©rcio.");

    const payload = {
      created_by: userId,
      assigned_to,
      status: "pendente",
      nome_comercio: nome.value.trim(),
      segmento: segmento.value.trim() || null,
      telefone: telefone.value.trim() || null,
      uf: (uf.value || "").trim().toUpperCase() || null,
      cidade: cidade.value.trim() || null,
      observacao: obs.value.trim() || null,
    };

    const { error } = await sb.from("demandas_credenciamento").insert(payload);
    if (error) throw error;

    nome.value = "";
    segmento.value = "";
    telefone.value = "";
    uf.value = "";
    cidade.value = "";
    obs.value = "";
  }

  try{
    const { user, profile } = await getProfile();
    who.textContent = `${profile.nome} â€¢ ${profile.papel}`;

    document.getElementById("btnLogout").onclick = logout;

    if (!isAdminRole(profile.papel)) {
      toast("Seu usuÃ¡rio nÃ£o tem acesso Ã  Central.");
      location.href = "dashboard.html";
    }

    await loadSellers();
    await loadList();

    btnCreate.addEventListener("click", async () => {
      btnCreate.disabled = true;
      btnCreate.textContent = "Criandoâ€¦";
      try{
        await createDemand(user.id);
        toast("Demanda criada âœ…");
        await loadList();
      }catch(err){
        console.error(err);
        toast("Erro ao criar demanda. Veja F12.");
      }finally{
        btnCreate.disabled = false;
        btnCreate.textContent = "Criar demanda";
      }
    });

  }catch(err){
    console.error(err);
    toast("Erro ao carregar Central. Veja F12.");
    listEl.innerHTML = `<div class="muted">Falha ao carregar.</div>`;
  }
</script>

</body>
</html>
