<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>CRM â€¢ Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>
  <div class="wrap">
    <header class="topbar">
      <div>
        <h1 style="margin:0">Credenciamento â€¢ Dashboard</h1>
        <div id="me" class="muted" style="margin-top:6px">Carregandoâ€¦</div>
      </div>

      <div class="actions" style="display:flex;gap:10px;align-items:center">
        <a class="btn" href="negociacao.html">+ Nova negociaÃ§Ã£o</a>
        <a class="btn" id="btnAdm" href="adm_demandas.html" style="display:none">ADM â€¢ Demandas</a>
        <button class="btn" id="btnLogout">Sair</button>
      </div>
    </header>

    <main style="margin-top:18px;display:grid;gap:16px;max-width:1100px">
      <section class="card">
        <h2 style="margin:0 0 10px 0">ðŸ“Œ PendÃªncias (Demandas)</h2>
        <div id="demandasEmpty" class="muted">Carregandoâ€¦</div>
        <div id="demandasList" style="display:grid;gap:10px"></div>
      </section>

      <section class="card">
        <h2 style="margin:0 0 10px 0">ðŸ“‹ Minhas negociaÃ§Ãµes</h2>
        <div id="negEmpty" class="muted">Carregandoâ€¦</div>
        <div id="negList" style="display:grid;gap:10px"></div>
      </section>
    </main>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { ensureProfile, logout, toast, humanError } from "./assets/app.js";

    const me = document.getElementById("me");
    const btnLogout = document.getElementById("btnLogout");
    const btnAdm = document.getElementById("btnAdm");

    const demandasEmpty = document.getElementById("demandasEmpty");
    const demandasList = document.getElementById("demandasList");

    const negEmpty = document.getElementById("negEmpty");
    const negList = document.getElementById("negList");

    btnLogout.addEventListener("click", logout);

    function cardHTML(title, meta, actionsHTML) {
      return `
        <div class="row-card" style="padding:12px;border-radius:14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08)">
          <div style="display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap;align-items:center">
            <div>
              <div style="font-weight:700">${title}</div>
              <div class="muted" style="margin-top:4px">${meta || ""}</div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">${actionsHTML || ""}</div>
          </div>
        </div>
      `;
    }

    async function load() {
      const ctx = await ensureProfile();
      const { user, prof } = ctx;

      me.textContent = `${user.email} â€¢ ${prof.papel}`;

      if (prof.papel === "adm" || prof.papel === "gestor") {
        btnAdm.style.display = "inline-flex";
      }

      // -------------------------
      // DEMANDAS (pendÃªncias)
      // -------------------------
      const { data: demandas, error: demErr } = await sb
        .from("demandas_credenciamento")
        .select("id,status,nome_comercio,segmento,telefone,uf,cidade,observacao,created_at,negociacao_id")
        .order("created_at", { ascending: false });

      if (demErr) {
        console.error(demErr);
        demandasEmpty.textContent = "NÃ£o consegui carregar demandas.";
      } else {
        const pend = (demandas || []).filter(d => d.status === "pendente" || d.status === "aceita");

        if (!pend.length) {
          demandasEmpty.textContent = "Sem pendÃªncias ðŸŽ‰";
          demandasList.innerHTML = "";
        } else {
          demandasEmpty.style.display = "none";
          demandasList.innerHTML = pend.map(d => {
            const meta = [
              d.segmento ? `Segmento: ${d.segmento}` : null,
              d.telefone ? `Tel: ${d.telefone}` : null,
              (d.cidade || d.uf) ? `Local: ${(d.cidade||"")}${d.cidade && d.uf ? " / " : ""}${(d.uf||"")}` : null,
              d.observacao ? `Obs: ${d.observacao}` : null,
              `Status: ${d.status}`
            ].filter(Boolean).join(" â€¢ ");

            const actions = `
              ${d.negociacao_id
                ? `<a class="btn" href="negociacao.html?id=${d.negociacao_id}">Abrir negociaÃ§Ã£o</a>`
                : `<button class="btn" data-aceitar="${d.id}">Aceitar e virar negociaÃ§Ã£o</button>`
              }
            `;
            return cardHTML(d.nome_comercio, meta, actions);
          }).join("");

          // bind buttons aceitar
          document.querySelectorAll("[data-aceitar]").forEach(btn => {
            btn.addEventListener("click", async () => {
              const demandaId = btn.getAttribute("data-aceitar");
              btn.disabled = true;
              btn.textContent = "Criandoâ€¦";

              try {
                // 1) pega a demanda
                const { data: demOne, error: e1 } = await sb
                  .from("demandas_credenciamento")
                  .select("*")
                  .eq("id", demandaId)
                  .single();

                if (e1) throw e1;

                // 2) cria negociaÃ§Ã£o
                const payload = {
                  created_by: user.id,
                  assigned_to: user.id,
                  status: "em_negociacao",
                  nome_comercio: demOne.nome_comercio,
                  segmento: demOne.segmento,
                  telefone: demOne.telefone,
                  contato_nome: demOne.contato_nome,
                  contato_email: demOne.contato_email,
                  uf: demOne.uf,
                  cidade: demOne.cidade,
                  observacao: demOne.observacao
                };

                const { data: neg, error: e2 } = await sb
                  .from("negociacoes")
                  .insert(payload)
                  .select("id")
                  .single();

                if (e2) throw e2;

                // 3) atualiza demanda -> aceita + link negociacao_id
                const { error: e3 } = await sb
                  .from("demandas_credenciamento")
                  .update({ status: "aceita", negociacao_id: neg.id })
                  .eq("id", demandaId);

                if (e3) throw e3;

                toast("Demanda aceita e virou negociaÃ§Ã£o âœ…");
                location.href = `negociacao.html?id=${neg.id}`;
              } catch (err) {
                console.error(err);
                toast(humanError(err));
                btn.disabled = false;
                btn.textContent = "Aceitar e virar negociaÃ§Ã£o";
              }
            });
          });
        }
      }

      // -------------------------
      // NEGOCIAÃ‡Ã•ES
      // -------------------------
      const { data: negs, error: negErr } = await sb
        .from("negociacoes")
        .select("id,status,nome_comercio,segmento,telefone,uf,cidade,updated_at")
        .order("updated_at", { ascending: false });

      if (negErr) {
        console.error(negErr);
        negEmpty.textContent = "NÃ£o consegui carregar negociaÃ§Ãµes.";
      } else {
        if (!negs || !negs.length) {
          negEmpty.textContent = "Nenhuma negociaÃ§Ã£o ainda. Clique em â€œ+ Nova negociaÃ§Ã£oâ€.";
          negList.innerHTML = "";
        } else {
          negEmpty.style.display = "none";
          negList.innerHTML = negs.map(n => {
            const meta = [
              n.status ? `Status: ${n.status}` : null,
              n.segmento ? `Segmento: ${n.segmento}` : null,
              n.telefone ? `Tel: ${n.telefone}` : null,
              (n.cidade || n.uf) ? `Local: ${(n.cidade||"")}${n.cidade && n.uf ? " / " : ""}${(n.uf||"")}` : null,
            ].filter(Boolean).join(" â€¢ ");

            const actions = `<a class="btn" href="negociacao.html?id=${n.id}">Abrir</a>`;
            return cardHTML(n.nome_comercio, meta, actions);
          }).join("");
        }
      }
    }

    load().catch(err => {
      console.error(err);
      toast("Falha ao carregar. Veja o console (F12).");
    });
  </script>
</body>
</html>
