<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Redefinir senha • CRM Ronny</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

  <div class="login-box">
    <h1>Nova senha</h1>
    <p class="muted" id="msg">Validando link…</p>

    <div id="form" style="display:none">
      <input id="newpass" type="password" placeholder="Nova senha (mín. 6)">
      <input id="newpass2" type="password" placeholder="Confirmar nova senha">
      <button id="btnSave">Salvar nova senha</button>
    </div>

    <p class="small muted" style="margin-top:12px">
      Se cair aqui e voltar pro login, peça “esqueci minha senha” de novo.
    </p>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { toast } from "./assets/app.js";

    const msgEl = document.getElementById("msg");
    const formEl = document.getElementById("form");

    async function init() {
      // 1) Se o link vier com ?code=..., troca por sessão (modo recomendado Supabase)
      const url = new URL(location.href);
      const code = url.searchParams.get("code");

      if (code) {
        const { error } = await sb.auth.exchangeCodeForSession(code);
        if (error) {
          console.error(error);
          toast("Link inválido/expirado. Solicite novamente.");
          msgEl.textContent = "Link inválido/expirado.";
          setTimeout(() => (location.href = "index.html"), 2000);
          return false;
        }
        return true;
      }

      // 2) Se o link vier com #access_token=...&refresh_token=... (modo antigo)
      const hash = location.hash || "";
      const params = new URLSearchParams(hash.replace("#", ""));
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      const type = params.get("type");

      if (access_token && refresh_token && (type === "recovery" || type === "signup")) {
        const { error } = await sb.auth.setSession({ access_token, refresh_token });
        if (error) {
          console.error(error);
          toast("Não consegui validar o link. Solicite novamente.");
          msgEl.textContent = "Não consegui validar o link.";
          setTimeout(() => (location.href = "index.html"), 2000);
          return false;
        }
        return true;
      }

      // 3) Se não tem code nem token, não é link de reset válido
      toast("Link inválido/expirado. Solicite novamente.");
      msgEl.textContent = "Link inválido/expirado.";
      setTimeout(() => (location.href = "index.html"), 1800);
      return false;
    }

    const ok = await init();
    if (!ok) throw new Error("recovery_init_failed");

    msgEl.textContent = "Pronto! Agora crie sua nova senha.";
    formEl.style.display = "block";

    document.getElementById("btnSave").onclick = async () => {
      const p1 = document.getElementById("newpass").value;
      const p2 = document.getElementById("newpass2").value;

      if (!p1 || p1.length < 6) {
        toast("A senha precisa ter pelo menos 6 caracteres.");
        return;
      }
      if (p1 !== p2) {
        toast("As senhas não conferem.");
        return;
      }

      const { error } = await sb.auth.updateUser({ password: p1 });
      if (error) {
        console.error(error);
        toast(error.message || "Erro ao salvar senha.");
        return;
      }

      toast("Senha alterada! Indo pro login…");
      setTimeout(() => (location.href = "index.html"), 1500);
    };
  </script>
</body>
</html>
