<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>CRM Ronny Vegas ‚Ä¢ Acesso</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

  <div class="login-box">
    <h1>CRM Equipe Ronny</h1>
    <p class="muted" id="subtitle">M√≥dulo: Credenciamento Vegas</p>

    <!-- LOGIN -->
    <div id="loginBox">
      <input id="email" type="email" placeholder="E-mail">
      <input id="password" type="password" placeholder="Senha">
      <button id="btnLogin">Entrar</button>

      <a href="#" id="btnForgot" class="link">Esqueci minha senha</a>
      <p class="small muted" id="forgotInfo" style="display:none;margin-top:10px"></p>
    </div>

    <!-- RESET SENHA -->
    <div id="resetBox" style="display:none">
      <p class="muted" id="resetMsg">Validando link‚Ä¶</p>

      <input id="newpass" type="password" placeholder="Nova senha (m√≠n. 6)">
      <input id="newpass2" type="password" placeholder="Confirmar nova senha">

      <button id="btnSave">Salvar nova senha</button>

      <a href="index.html" class="link" style="text-align:center">Voltar ao login</a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { toast } from "./assets/app.js";

    const loginBox = document.getElementById("loginBox");
    const resetBox = document.getElementById("resetBox");
    const subtitle = document.getElementById("subtitle");

    const emailEl  = document.getElementById("email");
    const passEl   = document.getElementById("password");

    const btnLogin = document.getElementById("btnLogin");
    const btnForgot= document.getElementById("btnForgot");

    const forgotInfo = document.getElementById("forgotInfo");

    const resetMsg = document.getElementById("resetMsg");
    const newpass  = document.getElementById("newpass");
    const newpass2 = document.getElementById("newpass2");
    const btnSave  = document.getElementById("btnSave");

    function showLogin(){
      subtitle.textContent = "M√≥dulo: Credenciamento Vegas";
      resetBox.style.display = "none";
      loginBox.style.display = "block";
    }

    function showReset(message){
      subtitle.textContent = "Redefini√ß√£o de senha";
      loginBox.style.display = "none";
      resetBox.style.display = "block";
      resetMsg.textContent = message || "Pronto! Crie sua nova senha.";
    }

    // LOGIN
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;

      if(!email || !password){
        toast("Preenche e-mail e senha üòÖ");
        return;
      }

      const { error } = await sb.auth.signInWithPassword({ email, password });

      if (error) {
        console.error("LOGIN ERROR:", error);
        toast("Login inv√°lido ou usu√°rio sem acesso.");
      } else {
        location.href = "dashboard.html";
      }
    });

    // ESQUECI MINHA SENHA (manda e-mail)
    btnForgot.addEventListener("click", async (e) => {
      e.preventDefault();

      forgotInfo.style.display = "block";
      forgotInfo.textContent = "";

      const email = emailEl.value.trim();
      if(!email){
        forgotInfo.textContent = "Digite seu e-mail acima e clique de novo.";
        toast("Digite seu e-mail primeiro üôÇ");
        return;
      }

      // redirect volta para o index mesmo (aqui tratamos reset)
      const basePath = location.pathname.replace(/\/[^\/]*$/, "");
      const redirectTo = `${location.origin}${basePath}/index.html`;

      forgotInfo.textContent = "Enviando e-mail de redefini√ß√£o‚Ä¶";

      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });

      if(error){
        console.error("RESET EMAIL ERROR:", error);
        forgotInfo.textContent = "N√£o consegui enviar o e-mail. Veja o console (F12).";
        toast(error.message || "Erro ao enviar reset.");
        return;
      }

      // ‚úÖ Confirma√ß√£o VIS√çVEL (n√£o depende do toast)
      forgotInfo.innerHTML =
        `‚úÖ E-mail enviado! Agora abre sua caixa de entrada (e o SPAM) e clique no link.<br>` +
        `<span class="small muted">Se n√£o chegar em 1‚Äì2 min, o usu√°rio pode n√£o existir no Auth.</span>`;
      toast("E-mail de redefini√ß√£o enviado ‚úÖ");
    });

    // Ao voltar do e-mail:
    async function initRecoveryIfAny(){
      const url = new URL(location.href);
      const code = url.searchParams.get("code");

      if(code){
        showReset("Validando link‚Ä¶");
        const { error } = await sb.auth.exchangeCodeForSession(code);
        if(error){
          console.error("EXCHANGE CODE ERROR:", error);
          toast("Link inv√°lido/expirado. Solicite novamente.");
          showLogin();
          return;
        }
        showReset("Pronto! Crie sua nova senha.");
        return;
      }

      const hash = location.hash || "";
      const params = new URLSearchParams(hash.replace("#",""));
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      const type = params.get("type");

      if(access_token && refresh_token && (type === "recovery" || type === "signup")){
        showReset("Validando link‚Ä¶");
        const { error } = await sb.auth.setSession({ access_token, refresh_token });
        if(error){
          console.error("SET SESSION ERROR:", error);
          toast("Link inv√°lido/expirado. Solicite novamente.");
          showLogin();
          return;
        }
        showReset("Pronto! Crie sua nova senha.");
      }
    }

    // salvar nova senha
    btnSave.addEventListener("click", async () => {
      const p1 = newpass.value;
      const p2 = newpass2.value;

      if(!p1 || p1.length < 6){
        toast("A senha precisa ter pelo menos 6 caracteres.");
        return;
      }
      if(p1 !== p2){
        toast("As senhas n√£o conferem.");
        return;
      }

      const { error } = await sb.auth.updateUser({ password: p1 });
      if(error){
        console.error("UPDATE PASSWORD ERROR:", error);
        toast(error.message || "Erro ao salvar senha.");
        return;
      }

      toast("Senha alterada! Agora entra com a nova üòÑ");
      setTimeout(() => {
        history.replaceState({}, document.title, "index.html");
        showLogin();
      }, 1200);
    });

    await initRecoveryIfAny();
  </script>
</body>
</html>
