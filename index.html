<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>CRM Ronny Vegas â€¢ Acesso</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

  <div class="login-box">
    <h1>CRM Equipe Ronny</h1>
    <p class="muted" id="subtitle">MÃ³dulo: Credenciamento Vegas</p>

    <!-- LOGIN -->
    <div id="loginBox">
      <input id="email" type="email" placeholder="E-mail">
      <input id="password" type="password" placeholder="Senha">
      <button id="btnLogin">Entrar</button>

      <a href="#" id="btnForgot" class="link">Esqueci minha senha</a>
    </div>

    <!-- RESET SENHA -->
    <div id="resetBox" style="display:none">
      <p class="muted" id="resetMsg">Validando linkâ€¦</p>

      <input id="newpass" type="password" placeholder="Nova senha (mÃ­n. 6)">
      <input id="newpass2" type="password" placeholder="Confirmar nova senha">

      <button id="btnSave">Salvar nova senha</button>

      <a href="index.html" class="link" style="text-align:center">Voltar ao login</a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { toast } from "./assets/app.js";

    const loginBox = document.getElementById("loginBox");
    const resetBox = document.getElementById("resetBox");
    const subtitle = document.getElementById("subtitle");

    const emailEl  = document.getElementById("email");
    const passEl   = document.getElementById("password");

    const btnLogin = document.getElementById("btnLogin");
    const btnForgot= document.getElementById("btnForgot");

    const resetMsg = document.getElementById("resetMsg");
    const newpass  = document.getElementById("newpass");
    const newpass2 = document.getElementById("newpass2");
    const btnSave  = document.getElementById("btnSave");

    function showLogin(){
      subtitle.textContent = "MÃ³dulo: Credenciamento Vegas";
      resetBox.style.display = "none";
      loginBox.style.display = "block";
    }

    function showReset(message){
      subtitle.textContent = "RedefiniÃ§Ã£o de senha";
      loginBox.style.display = "none";
      resetBox.style.display = "block";
      resetMsg.textContent = message || "Pronto! Crie sua nova senha.";
    }

    // 1) LOGIN
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;

      if(!email || !password){
        toast("Preenche e-mail e senha ðŸ˜…");
        return;
      }

      const { error } = await sb.auth.signInWithPassword({ email, password });

      if (error) {
        console.error(error);
        toast("Login invÃ¡lido ou usuÃ¡rio sem acesso.");
      } else {
        location.href = "dashboard.html";
      }
    });

    // 2) ESQUECI MINHA SENHA (manda email pelo prÃ³prio site)
    btnForgot.addEventListener("click", async (e) => {
      e.preventDefault();

      const email = emailEl.value.trim();
      if(!email){
        toast("Digite seu e-mail primeiro ðŸ™‚");
        return;
      }

      // redirect para o prÃ³prio index (aqui mesmo a gente trata o reset)
      const redirectTo = `${location.origin}${location.pathname.replace(/\/[^\/]*$/, "")}/index.html`;

      const { error } = await sb.auth.resetPasswordForEmail(email, { redirectTo });

      if(error){
        console.error(error);
        toast(error.message || "NÃ£o consegui enviar o e-mail de reset.");
        return;
      }

      toast("Enviei o e-mail de redefiniÃ§Ã£o. Confere a caixa de entrada.");
    });

    // 3) Ao voltar do e-mail, o Supabase pode trazer:
    // - ?code=... (modo novo)
    // - #access_token=... (modo antigo)
    async function initRecoveryIfAny(){
      const url = new URL(location.href);
      const code = url.searchParams.get("code");

      if(code){
        showReset("Validando linkâ€¦");
        const { error } = await sb.auth.exchangeCodeForSession(code);
        if(error){
          console.error(error);
          toast("Link invÃ¡lido/expirado. Solicite novamente.");
          showLogin();
          return;
        }
        showReset("Pronto! Crie sua nova senha.");
        return;
      }

      const hash = location.hash || "";
      const params = new URLSearchParams(hash.replace("#",""));
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      const type = params.get("type");

      if(access_token && refresh_token && (type === "recovery" || type === "signup")){
        showReset("Validando linkâ€¦");
        const { error } = await sb.auth.setSession({ access_token, refresh_token });
        if(error){
          console.error(error);
          toast("Link invÃ¡lido/expirado. Solicite novamente.");
          showLogin();
          return;
        }
        showReset("Pronto! Crie sua nova senha.");
      }
    }

    // 4) salvar nova senha
    btnSave.addEventListener("click", async () => {
      const p1 = newpass.value;
      const p2 = newpass2.value;

      if(!p1 || p1.length < 6){
        toast("A senha precisa ter pelo menos 6 caracteres.");
        return;
      }
      if(p1 !== p2){
        toast("As senhas nÃ£o conferem.");
        return;
      }

      const { error } = await sb.auth.updateUser({ password: p1 });
      if(error){
        console.error(error);
        toast(error.message || "Erro ao salvar senha.");
        return;
      }

      toast("Senha alterada! Agora entra com a nova senha ðŸ˜„");

      // limpa URL de recovery
      setTimeout(() => {
        history.replaceState({}, document.title, "index.html");
        showLogin();
      }, 1200);
    });

    // inicia tratamento do recovery se tiver
    await initRecoveryIfAny();
  </script>
</body>
</html>
