<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>CRM Ronny Vegas ‚Ä¢ Acesso</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

  <div class="login-box">
    <h1>CRM Equipe Ronny</h1>
    <p class="muted" id="subtitle">M√≥dulo: Credenciamento Vegas</p>

    <!-- LOGIN -->
    <div id="loginBox">
      <input id="email" type="email" placeholder="E-mail">
      <input id="password" type="password" placeholder="Senha">
      <button id="btnLogin">Entrar</button>
    </div>

    <!-- RESET SENHA -->
    <div id="resetBox" style="display:none">
      <p class="muted" id="resetMsg">Carregando redefini√ß√£o‚Ä¶</p>

      <input id="newpass" type="password" placeholder="Nova senha (m√≠n. 6)">
      <input id="newpass2" type="password" placeholder="Confirmar nova senha">
      <button id="btnSave">Salvar nova senha</button>

      <p class="small muted" style="margin-top:12px">
        Se der erro de link, solicite o reset novamente no Supabase.
      </p>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { toast } from "./assets/app.js";

    const loginBox  = document.getElementById("loginBox");
    const resetBox  = document.getElementById("resetBox");
    const subtitle  = document.getElementById("subtitle");
    const resetMsg  = document.getElementById("resetMsg");

    const emailEl   = document.getElementById("email");
    const passEl    = document.getElementById("password");
    const btnLogin  = document.getElementById("btnLogin");

    const newpass   = document.getElementById("newpass");
    const newpass2  = document.getElementById("newpass2");
    const btnSave   = document.getElementById("btnSave");

    let recoveryReady = false;

    function enterResetMode(message){
      subtitle.textContent = "Redefini√ß√£o de senha";
      loginBox.style.display = "none";
      resetBox.style.display = "block";
      resetMsg.textContent = message || "Validando link‚Ä¶";
      recoveryReady = false;
      btnSave.disabled = true;
    }

    function setResetReady(){
      resetMsg.textContent = "Pronto! Agora crie sua nova senha.";
      recoveryReady = true;
      btnSave.disabled = false;
    }

    async function initRecoveryIfAny(){
      const url = new URL(location.href);
      const code = url.searchParams.get("code");

      // A) link com ?code=...
      if (code) {
        enterResetMode("Validando link de recupera√ß√£o‚Ä¶");
        const { error } = await sb.auth.exchangeCodeForSession(code);
        if (error) {
          console.error(error);
          resetMsg.textContent = "Link inv√°lido/expirado. Solicite novamente.";
          toast("Link inv√°lido/expirado.");
          return;
        }
        setResetReady();
        return;
      }

      // B) link com #access_token=...&refresh_token=...
      const hash = location.hash || "";
      const params = new URLSearchParams(hash.replace("#",""));
      const access_token = params.get("access_token");
      const refresh_token = params.get("refresh_token");
      const type = params.get("type");

      if (access_token && refresh_token && (type === "recovery" || type === "signup")) {
        enterResetMode("Validando link de recupera√ß√£o‚Ä¶");
        const { error } = await sb.auth.setSession({ access_token, refresh_token });
        if (error) {
          console.error(error);
          resetMsg.textContent = "Link inv√°lido/expirado. Solicite novamente.";
          toast("Link inv√°lido/expirado.");
          return;
        }
        setResetReady();
        return;
      }

      // N√£o √© recovery ‚Üí segue login normal
    }

    // LOGIN
    btnLogin.addEventListener("click", async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;

      if(!email || !password){
        toast("Preenche e-mail e senha üòÖ");
        return;
      }

      const { error } = await sb.auth.signInWithPassword({ email, password });

      if (error) {
        console.error(error);
        toast("Login inv√°lido ou usu√°rio sem acesso.");
      } else {
        location.href = "dashboard.html";
      }
    });

    // SALVAR NOVA SENHA
    btnSave.addEventListener("click", async () => {
      if (!recoveryReady) {
        toast("Ainda validando o link‚Ä¶ aguarde 2s e tente de novo.");
        return;
      }

      const p1 = newpass.value;
      const p2 = newpass2.value;

      if (!p1 || p1.length < 6) {
        toast("A senha precisa ter pelo menos 6 caracteres.");
        return;
      }
      if (p1 !== p2) {
        toast("As senhas n√£o conferem.");
        return;
      }

      const { error } = await sb.auth.updateUser({ password: p1 });
      if (error) {
        console.error(error);
        toast(error.message || "Erro ao salvar senha.");
        return;
      }

      toast("Senha alterada! Agora √© s√≥ entrar üòÑ");

      // limpa URL (tira code/hash) pra n√£o ficar preso no reset
      setTimeout(() => {
        history.replaceState({}, document.title, "index.html");
        location.href = "index.html";
      }, 1200);
    });

    // inicia recovery (se tiver)
    await initRecoveryIfAny();
  </script>
</body>
</html>
