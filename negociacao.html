<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Negocia√ß√£o ‚Ä¢ Credenciamento</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

  <header class="top">
    <div>
      <h1>Negocia√ß√£o ‚Ä¢ Credenciamento</h1>
      <div class="muted" id="sub">Carregando‚Ä¶</div>
    </div>

    <div style="display:flex;gap:10px;align-items:center">
      <a class="btn-ghost" href="dashboard.html">Voltar</a>
      <button id="btnLogout" class="btn-ghost">Sair</button>
    </div>
  </header>

  <main class="wrap" style="display:grid;gap:16px;grid-template-columns: 1fr 1fr; align-items:start">

    <section class="card">
      <h2>üìå Dados da negocia√ß√£o</h2>

      <div class="grid2">
        <div>
          <label class="lbl">Nome do com√©rcio</label>
          <input id="nome_comercio" placeholder="Ex: Padaria do Z√©">
        </div>
        <div>
          <label class="lbl">CNPJ (opcional)</label>
          <input id="cnpj" placeholder="00.000.000/0000-00">
        </div>

        <div>
          <label class="lbl">Segmento</label>
          <input id="segmento" placeholder="Ex: Alimenta√ß√£o">
        </div>
        <div>
          <label class="lbl">Telefone</label>
          <input id="telefone" placeholder="(xx) xxxxx-xxxx">
        </div>

        <div>
          <label class="lbl">Contato</label>
          <input id="contato_nome" placeholder="Nome do respons√°vel">
        </div>
        <div>
          <label class="lbl">E-mail do contato</label>
          <input id="contato_email" placeholder="email@comercio.com">
        </div>

        <div>
          <label class="lbl">UF</label>
          <input id="uf" placeholder="SP" maxlength="2">
        </div>
        <div>
          <label class="lbl">Cidade</label>
          <input id="cidade" placeholder="Americana">
        </div>

        <div>
          <label class="lbl">Taxa adm (resumo)</label>
          <input id="taxa_adm" placeholder="Ex: 3,20%">
        </div>
        <div>
          <label class="lbl">Prazo pgto (resumo)</label>
          <input id="prazo_pgto" placeholder="Ex: dia 25">
        </div>
      </div>

      <div style="margin-top:10px">
        <label class="lbl">Observa√ß√£o</label>
        <textarea id="observacao" rows="4" placeholder="Contexto, argumentos, detalhes‚Ä¶"></textarea>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
        <button id="btnSave" class="btn">Salvar</button>
        <button id="btnConcluir" class="btn">Concluir negocia√ß√£o</button>
        <button id="btnFicha" class="btn" disabled title="S√≥ libera quando concluir">Gerar ficha</button>
      </div>

      <div class="muted small" style="margin-top:10px" id="statusInfo">‚Äî</div>
    </section>

    <section class="card">
      <h2>üïí Timeline</h2>

      <div class="grid2">
        <div>
          <label class="lbl">Tipo</label>
          <select id="log_tipo">
            <option value="nota">Nota</option>
            <option value="ligacao">Liga√ß√£o</option>
            <option value="whatsapp">WhatsApp</option>
            <option value="visita">Visita</option>
            <option value="email">E-mail</option>
            <option value="status">Status</option>
          </select>
        </div>
        <div>
          <label class="lbl">T√≠tulo</label>
          <input id="log_titulo" placeholder="Ex: Cliente pediu retorno amanh√£">
        </div>
      </div>

      <div style="margin-top:10px">
        <label class="lbl">Descri√ß√£o</label>
        <textarea id="log_desc" rows="3" placeholder="Detalhes‚Ä¶"></textarea>
      </div>

      <div style="margin-top:12px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnAddLog" class="btn">Adicionar na timeline</button>
      </div>

      <hr style="margin:16px 0; opacity:.25">

      <div id="logs" class="list">Carregando‚Ä¶</div>
    </section>

  </main>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { sb } from "./assets/supabaseClient.js";
    import { getProfile, logout, toast, q } from "./assets/app.js";

    const id = q("id"); // se existir, edita; se n√£o, cria

    const sub = document.getElementById("sub");
    const logsEl = document.getElementById("logs");
    const statusInfo = document.getElementById("statusInfo");

    const fields = [
      "nome_comercio","cnpj","segmento","telefone",
      "contato_nome","contato_email","uf","cidade",
      "taxa_adm","prazo_pgto","observacao"
    ];

    function getPayload(){
      const p = {};
      fields.forEach(k => p[k] = (document.getElementById(k).value || "").trim());
      // normalize UF
      if (p.uf) p.uf = p.uf.toUpperCase().slice(0,2);
      return p;
    }

    function setForm(data){
      fields.forEach(k => {
        const el = document.getElementById(k);
        el.value = data?.[k] ?? "";
      });
    }

    function logItemHTML(x){
      const dt = new Date(x.created_at);
      const when = dt.toLocaleString("pt-BR");
      return `
        <div class="item">
          <div class="row">
            <b>${x.titulo || "(sem t√≠tulo)"}</b>
            <span class="badge">${x.tipo}</span>
          </div>
          ${x.descricao ? `<div class="small" style="margin-top:6px">${x.descricao}</div>` : ""}
          <div class="muted small" style="margin-top:8px">${when}</div>
        </div>
      `;
    }

    async function loadLogs(negId){
      const { data, error } = await sb
        .from("action_logs")
        .select("id,tipo,titulo,descricao,created_at")
        .eq("negociacao_id", negId)
        .order("created_at", { ascending: false });

      if (error) throw error;

      logsEl.innerHTML = (data || []).length
        ? data.map(logItemHTML).join("")
        : `<div class="muted"><i>Sem registros ainda. Come√ßa com uma nota üòâ</i></div>`;
    }

    async function createNegociacao(user){
      const payload = getPayload();
      if(!payload.nome_comercio){
        toast("Coloca pelo menos o nome do com√©rcio üôÇ");
        throw new Error("nome_comercio_required");
      }

      payload.created_by = user.id;
      payload.assigned_to = user.id;
      payload.status = "em_negociacao";

      const { data, error } = await sb
        .from("negociacoes")
        .insert(payload)
        .select("*")
        .single();

      if (error) throw error;

      // log inicial
      await sb.from("action_logs").insert({
        negociacao_id: data.id,
        created_by: user.id,
        tipo: "sistema",
        titulo: "Negocia√ß√£o criada",
        descricao: "Registro inicial da negocia√ß√£o."
      });

      toast("Negocia√ß√£o criada ‚úÖ");
      location.href = `negociacao.html?id=${data.id}`;
    }

    async function saveNegociacao(negId){
      const payload = getPayload();
      if(!payload.nome_comercio){
        toast("Coloca pelo menos o nome do com√©rcio üôÇ");
        return;
      }
      const { error } = await sb
        .from("negociacoes")
        .update(payload)
        .eq("id", negId);

      if (error) throw error;

      toast("Salvo ‚úÖ");
    }

    async function concluirNegociacao(user, neg){
      if(neg.status === "concluida"){
        toast("Essa negocia√ß√£o j√° est√° conclu√≠da.");
        return;
      }

      const { error } = await sb
        .from("negociacoes")
        .update({ status: "concluida" })
        .eq("id", neg.id);

      if (error) throw error;

      await sb.from("action_logs").insert({
        negociacao_id: neg.id,
        created_by: user.id,
        tipo: "status",
        titulo: "Negocia√ß√£o conclu√≠da",
        descricao: "Status alterado para conclu√≠da."
      });

      toast("Negocia√ß√£o conclu√≠da ‚úÖ Agora pode gerar ficha.");
      await boot(user); // recarrega tela
    }

    async function gerarFicha(user, neg){
      if(neg.status !== "concluida"){
        toast("Conclua a negocia√ß√£o primeiro üôÇ");
        return;
      }

      // cria ficha puxando infos
      const payload = {
        negociacao_id: neg.id,
        created_by: user.id,
        status: "rascunho",
        nome_comercio: neg.nome_comercio,
        cnpj: neg.cnpj,
        segmento: neg.segmento,
        telefone: neg.telefone,
        contato_nome: neg.contato_nome,
        contato_email: neg.contato_email,
        uf: neg.uf,
        cidade: neg.cidade,
        observacao: neg.observacao
      };

      const { data, error } = await sb
        .from("fichas_credenciamento")
        .insert(payload)
        .select("id")
        .single();

      if (error) throw error;

      await sb.from("action_logs").insert({
        negociacao_id: neg.id,
        created_by: user.id,
        tipo: "sistema",
        titulo: "Ficha gerada",
        descricao: `Ficha criada (ID: ${data.id}).`
      });

      toast("Ficha gerada ‚úÖ (vamos criar a tela dela no pr√≥ximo passo)");
      // depois fazemos ficha.html?id=...
    }

    async function addLog(user, negId){
      const tipo = document.getElementById("log_tipo").value;
      const titulo = document.getElementById("log_titulo").value.trim();
      const descricao = document.getElementById("log_desc").value.trim();

      if(!titulo && !descricao){
        toast("Escreve um t√≠tulo ou uma descri√ß√£o üôÇ");
        return;
      }

      const { error } = await sb.from("action_logs").insert({
        negociacao_id: negId,
        created_by: user.id,
        tipo,
        titulo: titulo || "(sem t√≠tulo)",
        descricao
      });

      if (error) throw error;

      document.getElementById("log_titulo").value = "";
      document.getElementById("log_desc").value = "";
      toast("Adicionado na timeline ‚úÖ");
      await loadLogs(negId);
    }

    async function boot(user){
      if(!id){
        sub.textContent = "Nova negocia√ß√£o (ainda n√£o salva)";
        statusInfo.textContent = "Preencha e clique em ‚ÄúSalvar‚Äù para criar.";
        logsEl.innerHTML = `<div class="muted"><i>Salve a negocia√ß√£o para liberar a timeline.</i></div>`;

        document.getElementById("btnSave").onclick = () => createNegociacao(user);
        document.getElementById("btnConcluir").disabled = true;
        document.getElementById("btnFicha").disabled = true;
        document.getElementById("btnAddLog").disabled = true;
        return;
      }

      // carrega negocia√ß√£o
      const { data: neg, error } = await sb
        .from("negociacoes")
        .select("*")
        .eq("id", id)
        .single();

      if (error) throw error;

      sub.textContent = `${neg.nome_comercio} ‚Ä¢ ${neg.status}`;
      setForm(neg);

      statusInfo.textContent = neg.status === "concluida"
        ? "Status: conclu√≠da. Voc√™ pode gerar a ficha."
        : "Status: em negocia√ß√£o. Conclua quando fechar com o cliente.";

      document.getElementById("btnSave").onclick = async () => {
        try { await saveNegociacao(neg.id); }
        catch(e){ console.error(e); toast("Erro ao salvar. Veja o console (F12)."); }
      };

      document.getElementById("btnConcluir").onclick = async () => {
        try { await concluirNegociacao(user, neg); }
        catch(e){ console.error(e); toast("Erro ao concluir. Veja o console (F12)."); }
      };

      const btnFicha = document.getElementById("btnFicha");
      btnFicha.disabled = (neg.status !== "concluida");
      btnFicha.onclick = async () => {
        try { await gerarFicha(user, neg); }
        catch(e){ console.error(e); toast("Erro ao gerar ficha. Veja o console (F12)."); }
      };

      document.getElementById("btnAddLog").disabled = false;
      document.getElementById("btnAddLog").onclick = async () => {
        try { await addLog(user, neg.id); }
        catch(e){ console.error(e); toast("Erro ao adicionar log. Veja o console (F12)."); }
      };

      await loadLogs(neg.id);
    }

    try {
      const { user } = await getProfile();
      document.getElementById("btnLogout").onclick = logout;
      await boot(user);
    } catch (err) {
      console.error(err);
      toast("Erro ao carregar negocia√ß√£o. Veja o console (F12).");
    }
  </script>
</body>
</html>
