<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Negocia√ß√£o ‚Ä¢ Credenciamento</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="assets/app.css">
</head>
<body>

<header class="top">
  <div>
    <h1 id="title">Negocia√ß√£o</h1>
    <div class="muted" id="who">Carregando‚Ä¶</div>
  </div>

  <div style="display:flex;gap:10px;align-items:center">
    <a class="btn-ghost" href="dashboard.html">Voltar</a>
    <button id="btnLogout" class="btn-ghost">Sair</button>
  </div>
</header>

<main class="wrap">

  <section class="card">
    <h2>üìÑ Dados do com√©rcio</h2>

    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="label">Origem</div>
        <select id="origem">
          <option value="adm_comercial">Adm Comercial</option>
          <option value="pos_venda">P√≥s-venda</option>
          <option value="venda_nova">Venda Nova</option>
          <option value="canais_vendas">Canais de Vendas</option>
          <option value="melhoria_rede">Melhoria de Rede</option>
          <option value="cliente_vegas">Cliente Vegas</option>
        </select>
      </div>

      <div>
        <div class="label">Status</div>
        <select id="status">
          <option value="em_negociacao">Em negocia√ß√£o</option>
          <option value="concluida">Conclu√≠da (Contrato firmado)</option>
          <option value="sem_interesse">Sem interesse</option>
        </select>
      </div>

      <div>
        <div class="label">CNPJ</div>
        <input id="cnpj" placeholder="Somente n√∫meros (opcional)">
      </div>

      <div>
        <div class="label">Nome fantasia</div>
        <input id="nome_fantasia" placeholder="Ex: Padaria do Z√©">
      </div>

      <div>
        <div class="label">Raz√£o social</div>
        <input id="razao_social" placeholder="Opcional">
      </div>

      <div>
        <div class="label">Segmento</div>
        <input id="segmento" placeholder="Ex: Alimenta√ß√£o">
      </div>

      <div>
        <div class="label">UF</div>
        <input id="uf" maxlength="2" placeholder="SP">
      </div>

      <div>
        <div class="label">Cidade</div>
        <input id="cidade" placeholder="Campinas">
      </div>
    </div>
  </section>

  <section class="card">
    <h2>‚òéÔ∏è Contato</h2>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="label">Nome</div>
        <input id="contato_nome" placeholder="Contato principal">
      </div>
      <div>
        <div class="label">Telefone</div>
        <input id="contato_telefone" placeholder="(xx) xxxxx-xxxx">
      </div>
      <div>
        <div class="label">E-mail</div>
        <input id="contato_email" placeholder="contato@empresa.com">
      </div>
    </div>
  </section>

  <section class="card">
    <h2>üíº Acordo comercial</h2>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="label">Taxa adm (%)</div>
        <input id="taxa_adm" placeholder="Ex: 3.50">
      </div>
      <div>
        <div class="label">Prazo de pagamento</div>
        <input id="prazo_pagamento" placeholder="Ex: dia 25 / dia 15">
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="label">Observa√ß√µes do acordo</div>
      <textarea id="acordo_obs" rows="4" placeholder="Detalhes do combinado‚Ä¶"></textarea>
    </div>
  </section>

  <section class="card">
    <h2>‚è≠Ô∏è Pr√≥xima a√ß√£o</h2>
    <div class="grid2" style="margin-top:10px">
      <div>
        <div class="label">Pr√≥xima a√ß√£o</div>
        <input id="prox_acao" placeholder="Ex: Voltar amanh√£ √†s 14h">
      </div>
      <div>
        <div class="label">Data</div>
        <input id="prox_data" type="date">
      </div>
    </div>
  </section>

  <section class="card">
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn" id="btnSave">Salvar</button>
      <button class="btn-ghost" id="btnGoFicha" style="display:none" disabled title="Vamos habilitar depois">
        Gerar ficha (pr√≥ximo m√≥dulo)
      </button>
    </div>
  </section>

</main>

<div class="toast" id="toast"></div>

<script type="module">
  import { sb } from "./assets/supabaseClient.js";
  import { getProfile, logout, toast } from "./assets/app.js";

  const url = new URL(location.href);
  const id = url.searchParams.get("id");

  const $ = (x) => document.getElementById(x);

  function setVal(id, v){ $(id).value = (v ?? ""); }
  function getVal(id){ return $(id).value?.trim(); }

  async function loadNeg(negId){
    const { data, error } = await sb
      .from("negociacoes")
      .select("*")
      .eq("id", negId)
      .single();

    if (error) throw error;

    $("title").textContent = "Negocia√ß√£o ‚Ä¢ " + (data.nome_fantasia || "Sem nome");

    setVal("origem", data.origem);
    setVal("status", data.status);
    setVal("cnpj", data.cnpj);
    setVal("nome_fantasia", data.nome_fantasia);
    setVal("razao_social", data.razao_social);
    setVal("segmento", data.segmento);
    setVal("uf", data.uf);
    setVal("cidade", data.cidade);

    setVal("contato_nome", data.contato_nome);
    setVal("contato_telefone", data.contato_telefone);
    setVal("contato_email", data.contato_email);

    setVal("taxa_adm", data.taxa_adm);
    setVal("prazo_pagamento", data.prazo_pagamento);
    setVal("acordo_obs", data.acordo_obs);

    setVal("prox_acao", data.prox_acao);
    setVal("prox_data", data.prox_data);

    // se concluiu, mostra bot√£o gerar ficha (ainda desabilitado por enquanto)
    if (data.status === "concluida") {
      $("btnGoFicha").style.display = "inline-block";
    }
  }

  async function saveNeg(userId){
    const payload = {
      produto: "credenciamento",
      origem: getVal("origem") || "adm_comercial",
      status: getVal("status") || "em_negociacao",

      cnpj: getVal("cnpj") || null,
      nome_fantasia: getVal("nome_fantasia") || null,
      razao_social: getVal("razao_social") || null,
      segmento: getVal("segmento") || null,
      uf: (getVal("uf") || "").toUpperCase() || null,
      cidade: getVal("cidade") || null,

      contato_nome: getVal("contato_nome") || null,
      contato_telefone: getVal("contato_telefone") || null,
      contato_email: getVal("contato_email") || null,

      taxa_adm: getVal("taxa_adm") ? Number(String(getVal("taxa_adm")).replace(",", ".")) : null,
      prazo_pagamento: getVal("prazo_pagamento") || null,
      acordo_obs: getVal("acordo_obs") || null,

      prox_acao: getVal("prox_acao") || null,
      prox_data: getVal("prox_data") || null,
    };

    if (!payload.nome_fantasia && !payload.razao_social) {
      toast("Coloca pelo menos Nome fantasia ou Raz√£o social üôÇ");
      return null;
    }

    if (!id) {
      // cria
      payload.created_by = userId;
      payload.assigned_to = userId;

      const { data, error } = await sb
        .from("negociacoes")
        .insert(payload)
        .select("id")
        .single();

      if (error) throw error;
      return data.id;
    } else {
      // atualiza
      const { error } = await sb
        .from("negociacoes")
        .update(payload)
        .eq("id", id);

      if (error) throw error;
      return id;
    }
  }

  try{
    const { user, profile } = await getProfile();
    $("who").textContent = `${profile.nome} ‚Ä¢ ${profile.papel}`;
    $("btnLogout").onclick = logout;

    if (id) await loadNeg(id);

    $("btnSave").addEventListener("click", async () => {
      $("btnSave").disabled = true;
      $("btnSave").textContent = "Salvando‚Ä¶";
      try{
        const newId = await saveNeg(user.id);
        toast("Salvo ‚úÖ");
        if (!id && newId) location.href = `negociacao.html?id=${newId}`;
      }catch(err){
        console.error(err);
        toast("Erro ao salvar. Veja F12.");
      }finally{
        $("btnSave").disabled = false;
        $("btnSave").textContent = "Salvar";
      }
    });

  }catch(err){
    console.error(err);
    toast("Erro ao carregar negocia√ß√£o. Veja F12.");
  }
</script>

</body>
</html>
